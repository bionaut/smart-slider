// Generated by CoffeeScript 1.8.0
(function() {
  angular.module('smartSlider.module', []).factory('mouseService', function($window, $rootScope) {
    var sId, selected;
    selected = null;
    sId = null;
    angular.element($window).on('touchend mouseup', function(ev) {
      $rootScope.$broadcast('selectedreleased');
      selected = null;
      return sId = null;
    });
    angular.element($window).on('touchmove mousemove', function(ev) {
      ev.stopPropagation();
      if (selected) {
        if (ev.targetTouches && ev.type === 'touchmove') {
          return $rootScope.$broadcast('moveselected', ev.targetTouches[0].pageX);
        } else {
          return $rootScope.$broadcast('moveselected', ev.pageX);
        }
      }
    });
    return {
      selected: function(element, id) {
        if (element != null) {
          sId = id;
          return selected = element;
        } else {
          return [selected, sId];
        }
      }
    };
  }).directive('smartSlider', function(mouseService) {
    return {
      scope: {
        min: '=?',
        max: '=?',
        step: '=?',
        model: '=?',
        limits: '=?',
        sections: '=?',
        tooltip: '=?'
      },
      restrict: 'E',
      templateUrl: "slider.tmp.html",
      replace: true,
      controller: function($scope, $element, $timeout) {
        var s;
        s = $scope;
        if (!s.min) {
          s.min = 0;
        }
        if (!s.max) {
          s.max = 100;
        }
        if (!s.step) {
          s.step = 1;
        }
        s.$on('moveselected', function(ev, pageX, $rootScope) {
          var handle, offset, percInPx, targetScope, wrap;
          if (s.$id === mouseService.selected()[1]) {
            targetScope = ev.targetScope;
            handle = mouseService.selected()[0];
            wrap = handle.parent();
            offset = s.getOffset(wrap);
            offset.percentage = offset.width / 100;
            percInPx = (pageX - offset.left) / offset.percentage;
            s.model = s.getValueOfPercentage(percInPx, offset);
            return s.$apply();
          }
        });
        s.$watch('model', function(n, o) {
          var num, stepDif, _i, _ref, _results;
          if (n === void 0) {
            s.model = s.min;
          }
          if (isNaN(s.model)) {
            s.model = s.min;
          }
          s.model = parseInt(s.model);
          if (n < s.min) {
            s.model = s.min;
          }
          if (n > s.max) {
            s.model = s.max;
          }
          s.model = s.roundNum(s.model, s.step, 0);
          if (angular.isObject(s.tooltip)) {
            angular.forEach(s.tooltip, function(value, key) {
              if (parseInt(key) <= s.model) {
                return s.showTooltip = value;
              } else {
                return s.showTooltip = null;
              }
            });
          }
          if (o !== void 0 || n !== void 0 && s.sections && s.breakpoints === void 0) {
            s.breakpoints = [];
            stepDif = s.max / s.sections;
            _results = [];
            for (num = _i = 1, _ref = s.sections; 1 <= _ref ? _i <= _ref : _i >= _ref; num = 1 <= _ref ? ++_i : --_i) {
              if ((num * stepDif) > s.min) {
                _results.push(s.breakpoints.push(s.roundNum(stepDif * num, s.step, 0)));
              } else {
                _results.push(void 0);
              }
            }
            return _results;
          }
        });
        s.roundNum = function(number, increment, offset) {
          return Math.round((number - offset) / increment) * increment + offset;
        };
        s.getOffset = function(element) {
          var offset;
          offset = element[0].getBoundingClientRect();
          return offset;
        };
        s.getPercentage = function(n) {
          var onePerc;
          onePerc = (s.max - s.min) / 100;
          return ((n - s.min) / onePerc) + "%";
        };
        s.getValueOfPercentage = function(perc, offset) {
          var range;
          if (s.max > s.min) {
            range = s.max - s.min;
          } else {
            range = s.min - s.max;
          }
          if (offset != null) {
            return s.roundNum(((perc / 100) * range) + s.min, s.step, 0);
          }
        };
        s.goTo = function(value) {
          if (value != null) {
            s.model = value;
          }
        };
        s.add = function(step) {
          s.model += step;
          if (s.model > s.max) {
            return s.model = s.max;
          }
        };
        return s.subtract = function(step) {
          s.model -= step;
          if (s.model < s.min) {
            return s.model = s.min;
          }
        };
      }
    };
  }).directive('stopPropagation', function() {
    return function(s, e, a) {
      return e.bind('click mousedown touchstart', function(e) {
        return e.stopPropagation();
      });
    };
  }).directive('detectClick', function() {
    return function(s, e, a) {
      return e.bind('click', function(ev) {
        var offset, percInPx;
        offset = s.getOffset(e);
        offset.percentage = offset.width / 100;
        percInPx = (ev.pageX - offset.left) / offset.percentage;
        s.model = s.getValueOfPercentage(percInPx, offset);
        return s.$apply();
      });
    };
  }).directive('smartHandle', function(mouseService, $rootScope) {
    return function(s, e, a) {
      return e.bind('touchstart mousedown', function(ev) {
        ev.stopPropagation();
        mouseService.selected(e, s.$id);
        return s.$apply();
      });
    };
  });

}).call(this);
